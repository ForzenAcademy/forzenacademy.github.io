<!-- index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />

    <!-- iOS Safari: prevent pinch-zoom/double-tap zoom (game-only page) -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no"
    />

    <title>forzenboy</title>

    <!-- Set the mobile class ASAP to avoid a flash of wrong layout -->
    <script>
      (function () {
        const ua = navigator.userAgent || '';
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        // Touch capability
        const hasTouch =
          (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) || 'ontouchstart' in window;

        // Consider it "mobile UI" if it's Android/iOS with touch.
        // This sidesteps inconsistent hover/pointer media-query reporting on some Samsung devices.
        const isMobile = hasTouch && (isAndroid || isIOS);

        if (isMobile) document.documentElement.classList.add('is-mobile');
      })();
    </script>

    <script type="module" src="./bundle.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      /* Prevent iOS "Copy" callout / selection highlight while dragging */
      html,
      body,
      canvas,
      #control-pane,
      #joystick-hit,
      .joystick,
      .joystick * {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
      }
      *::selection {
        background: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        background: #2d2d2d;
        overscroll-behavior: none;
      }

      canvas {
        display: block;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;

        /* Prevent gesture interactions */
        touch-action: none;
      }

      /* Defaults = desktop */
      .hide-mobile {
        display: none !important;
      }
      .hide-desktop {
        display: flex !important;
      }

      /* Wrapper centers canvas on desktop */
      .canvas-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #2d2d2d;
      }

      .child {
        width: 50%;
        display: flex;
        align-items: flex-end;
      }

      .gameboy-button {
        opacity: 0.4;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 60px; /* keep big always */
        height: 60px; /* keep big always */
        background-color: #5c5c5c;
        border-radius: 50%;
        box-shadow:
          inset 0 0 0 5px #9c9c9c,
          inset 0 0 0 10px #404040;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 20px;
        color: #1c1c1c;
        user-select: none;
        transition: 0.1s ease-in-out;
      }

      .gameboy-button:active {
        transform: translateY(2px);
        box-shadow:
          inset 0 0 0 5px #9c9c9c,
          inset 0 0 0 8px #404040;
      }

      /* NES-style start button (oval, no label) */
      .start-button {
        opacity: 0.4;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 96px;
        height: 34px;
        background-color: #5c5c5c;
        border-radius: 999px; /* pill */
        box-shadow:
          inset 0 0 0 4px #9c9c9c,
          inset 0 0 0 8px #404040;
        user-select: none;
        transition: 0.1s ease-in-out;
      }

      .start-button:active {
        transform: translateY(2px);
        box-shadow:
          inset 0 0 0 4px #9c9c9c,
          inset 0 0 0 6px #404040;
      }

      #buttons {
        justify-content: flex-end;
        padding: 0.5in;
      }

      #joystick-container {
        justify-content: flex-start;
        padding: 0.33in;
      }

      /* center slot for start button */
      #start-container {
        width: auto;
        justify-content: center;
        padding: 0.33in 0;
      }

      .joystick {
        position: relative;
        width: 1in;
        height: 1in;
        border-radius: 50%;
        opacity: 0.4;
        border: 1px solid #fff;
        background-color: #666;
        user-select: none;
        touch-action: none; /* important for pointer events */
      }

      .joystick .inner-circle {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 0.66in;
        height: 0.66in;
        border-radius: 50%;
        opacity: 0.4;
        background-color: #fff;
        user-select: none;
        transform: translate(-50%, -50%); /* important */
        will-change: transform;
      }

      /* ============================================================
         MOBILE UI: driven by html.is-mobile (reliable on Samsung)
         ============================================================ */
      html.is-mobile,
      html.is-mobile body {
        background: black !important;
      }

      /* CRITICAL: lock the page on mobile so iOS can't scroll/pan it */
      html.is-mobile,
      html.is-mobile body {
        height: 100%;
        overflow: hidden;
        position: fixed;
        width: 100%;
      }

      html.is-mobile .hide-mobile {
        display: flex !important;
      }

      html.is-mobile .hide-desktop {
        display: none !important;
      }

      html.is-mobile .canvas-wrapper {
        background: black !important;
        width: 100vw;

        /* Prefer dvh; fallback is ok */
        height: 100vh;
        height: 100dvh;
      }

      html.is-mobile canvas {
        max-width: 100%;
        max-height: 100%;
      }

      /* Overlay controls: no blur/backdrop, overlaps canvas */
      html.is-mobile #control-pane {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        display: flex;
        z-index: 999999;

        height: 110px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-top: 10px;

        background: transparent;
        pointer-events: auto;
      }

      html.is-mobile .child {
        align-items: center;
      }

      html.is-mobile #joystick-container {
        padding: 10px 12px;
        position: relative;
      }

      html.is-mobile #start-container {
        padding: 10px 0;
        justify-content: center;
      }

      html.is-mobile #buttons {
        padding: 10px 12px;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
      }

      html.is-mobile .joystick {
        width: 96px;
        height: 96px;
      }

      html.is-mobile .joystick .inner-circle {
        width: 64px;
        height: 64px;
      }

      /* ============================================================
         SUPER GENEROUS HIT REGION (mobile) — NOW FULL VERTICAL SLAB
         ============================================================ */
      html.is-mobile #joystick-hit {
        position: fixed;

        /* Left-side slab width: tune this */
        left: 0;
        width: min(62vw, 640px);
        max-width: 820px;

        /* FULL vertical generosity */
        top: 0;
        bottom: 0;

        /* Respect notches */
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);

        z-index: 999998; /* below control-pane (999999) but above canvas */
        background: transparent;
        touch-action: none;
      }

      /* Keep the visible joystick above the hit region */
      html.is-mobile #control-pane {
        z-index: 999999;
      }

      /* Optional fallback: keep your original media query too (doesn't hurt) */
      @media (hover: none) and (pointer: coarse) {
        html:not(.is-mobile) .hide-mobile {
          display: flex !important;
        }
        html:not(.is-mobile) .hide-desktop {
          display: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="canvas-wrapper">
      <canvas id="canvas" width="240" height="160"></canvas>
    </div>

    <div class="hide-mobile" id="control-pane">
      <div class="child" id="joystick-container">
        <!-- SUPER generous full-vertical left-side touch region -->
        <div id="joystick-hit"></div>

        <div class="joystick">
          <div class="inner-circle"></div>
        </div>
      </div>

      <div class="child" id="start-container">
        <div class="start-button" id="startbutton"></div>
      </div>

      <div class="child" id="buttons">
        <div class="gameboy-button" id="xbutton">B</div>
        <div class="gameboy-button" id="zbutton">A</div>
      </div>
    </div>

    <script>
      function resizeGameCanvas() {
        const canvas = document.getElementById('canvas');
        if (!canvas) return;

        const baseW = 240;
        const baseH = 160;
        const aspect = baseW / baseH;

        // visualViewport is best on mobile; fallback is window inner dims.
        const vv = window.visualViewport;
        const vw = (vv ? vv.width : window.innerWidth) || window.innerWidth;
        const vh = (vv ? vv.height : window.innerHeight) || window.innerHeight;

        const availW = vw;
        const availH = vh;

        let h = availH;
        let w = h * aspect;
        if (w > availW) {
          w = availW;
          h = w / aspect;
        }

        canvas.style.width = `${Math.floor(w)}px`;
        canvas.style.height = `${Math.floor(h)}px`;
      }

      function onViewportChange() {
        resizeGameCanvas();
      }

      window.addEventListener('load', onViewportChange, { passive: true });
      window.addEventListener('resize', onViewportChange, { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(onViewportChange, 250), {
        passive: true,
      });

      // iOS Safari: visualViewport.scroll can create feedback loops / jitter — do NOT listen to it.
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', onViewportChange, { passive: true });
      }

      // iOS Safari: prevent page scroll / pinch zoom / callouts while interacting
      (function () {
        const ua = navigator.userAgent || '';
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        if (!isIOS) return;

        const blocker = (e) => {
          const t = e.target;
          if (t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA')) return;
          e.preventDefault();
        };

        // Prevent panning/scrolling
        document.addEventListener('touchstart', blocker, { passive: false });
        document.addEventListener('touchmove', blocker, { passive: false });

        // Prevent pinch zoom gestures (older iOS safari)
        document.addEventListener('gesturestart', blocker, { passive: false });
        document.addEventListener('gesturechange', blocker, { passive: false });
        document.addEventListener('gestureend', blocker, { passive: false });

        // Prevent double-tap zoom on some iOS versions
        let lastTouchEnd = 0;
        document.addEventListener(
          'touchend',
          (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
          },
          { passive: false },
        );
      })();
    </script>
  </body>
</html>
