<!-- index.html -->
<!doctype html>
<html lang="en" translate="no">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="google" content="notranslate" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EW36ZR1BPV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-EW36ZR1BPV');
    </script>

    <!-- iOS Safari: game-only page; prevent pinch-zoom/double-tap zoom -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no"
    />

    <title>forzenboy</title>

    <!-- Set the mobile class ASAP to avoid a flash of wrong layout -->
    <script>
      (function () {
        const ua = navigator.userAgent || '';
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        const hasTouch =
          (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) || 'ontouchstart' in window;

        const isMobile = hasTouch && (isAndroid || isIOS);
        if (isMobile) document.documentElement.classList.add('is-mobile');
      })();
    </script>

    <script>
      window.ANALYTICS_BRIDGE = {
        event(name, params) {
          gtag('event', name, params || {});
        },
      };
    </script>
    <script type="module" src="./bundle.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      /* Prevent iOS "Copy" callout / selection highlight while dragging */
      html,
      body,
      canvas,
      #control-pane,
      #joystick-hit,
      .joystick,
      .joystick * {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
      }
      *::selection {
        background: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        background: #2d2d2d;
        overscroll-behavior: none;
      }

      canvas {
        display: block;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
        touch-action: none;
      }

      /* Defaults = desktop */
      .hide-mobile {
        display: none !important;
      }
      .hide-desktop {
        display: flex !important;
      }

      .canvas-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #2d2d2d;
      }

      .child {
        width: 50%;
        display: flex;
        align-items: flex-end;
      }

      .gameboy-button {
        opacity: 0.4;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        background-color: #5c5c5c;
        border-radius: 50%;
        box-shadow:
          inset 0 0 0 5px #9c9c9c,
          inset 0 0 0 10px #404040;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 20px;
        color: #1c1c1c;
        transition: 0.1s ease-in-out;
      }

      .gameboy-button:active {
        transform: translateY(2px);
        box-shadow:
          inset 0 0 0 5px #9c9c9c,
          inset 0 0 0 8px #404040;
      }

      /* Start button (smaller now) */
      .start-button {
        opacity: 0.4;
        display: inline-flex;
        align-items: center;
        justify-content: center;

        width: 78px; /* smaller */
        height: 28px; /* smaller */

        background-color: #5c5c5c;
        border-radius: 999px;
        box-shadow:
          inset 0 0 0 4px #9c9c9c,
          inset 0 0 0 8px #404040;
        transition: 0.1s ease-in-out;
      }

      .start-button:active {
        transform: translateY(2px);
        box-shadow:
          inset 0 0 0 4px #9c9c9c,
          inset 0 0 0 6px #404040;
      }

      #buttons {
        justify-content: flex-end;
        padding: 0.5in;
      }

      #joystick-container {
        justify-content: flex-start;
        padding: 0.33in;
      }

      #start-container {
        width: auto;
        justify-content: center;
        padding: 0.33in 0;
      }

      .joystick {
        position: relative;
        width: 1in;
        height: 1in;
        border-radius: 50%;
        opacity: 0.4;
        border: 1px solid #fff;
        background-color: #666;
        touch-action: none;
      }

      .joystick .inner-circle {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 0.66in;
        height: 0.66in;
        border-radius: 50%;
        opacity: 0.4;
        background-color: #fff;
        transform: translate(-50%, -50%);
        will-change: transform;
      }

      /* ============================================================
         MOBILE UI
         ============================================================ */
      html.is-mobile,
      html.is-mobile body {
        background: black !important;
      }

      /* Lock page so iOS can't scroll/pan */
      html.is-mobile,
      html.is-mobile body {
        height: 100%;
        overflow: hidden;
        position: fixed;
        width: 100%;
      }

      /* Single source of truth for joystick column width */
      html.is-mobile {
        /* joystick capture column width:
           - make it generous, but keep it strictly left-side only */
        --joystick-col-w: min(45vw, 520px);
      }

      html.is-mobile .hide-mobile {
        display: flex !important;
      }

      html.is-mobile .hide-desktop {
        display: none !important;
      }

      html.is-mobile .canvas-wrapper {
        background: black !important;
        width: 100vw;
        height: 100vh;
        height: 100dvh;
      }

      html.is-mobile canvas {
        max-width: 100%;
        max-height: 100%;
      }

      html.is-mobile #control-pane {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        display: flex;
        z-index: 999999;

        height: 110px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-top: 10px;

        background: transparent;
        pointer-events: auto;
      }

      html.is-mobile .child {
        align-items: center;
      }

      html.is-mobile #joystick-container {
        padding: 10px 12px;
        position: relative;
      }

      html.is-mobile #start-container {
        padding: 10px 0;
        justify-content: center;
      }

      html.is-mobile #buttons {
        padding: 10px 12px;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
      }

      html.is-mobile .joystick {
        width: 96px;
        height: 96px;
      }

      html.is-mobile .joystick .inner-circle {
        width: 64px;
        height: 64px;
      }

      /* ============================================================
         JOYSTICK HIT REGION: FULL HEIGHT LEFT COLUMN
         - Can be touched ANYWHERE on the bottom (because it's full height).
         - Cannot intercept Start because it never enters the center column.
         ============================================================ */
      html.is-mobile #joystick-hit {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;

        width: var(--joystick-col-w);

        /* Respect notch/safe areas */
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);

        z-index: 999998; /* below control pane, above canvas */
        background: transparent;
        touch-action: none;
      }

      /* Keep visible controls above hit region */
      html.is-mobile #control-pane {
        z-index: 999999;
      }

      @media (hover: none) and (pointer: coarse) {
        html:not(.is-mobile) .hide-mobile {
          display: flex !important;
        }
        html:not(.is-mobile) .hide-desktop {
          display: none !important;
        }
      }
    </style>
  </head>

  <body translate="no">
    <div class="canvas-wrapper">
      <canvas id="canvas" width="240" height="160"></canvas>
    </div>

    <div class="hide-mobile" id="control-pane">
      <div class="child" id="joystick-container">
        <!-- FULL HEIGHT LEFT COLUMN hit region -->
        <div id="joystick-hit"></div>

        <div class="joystick">
          <div class="inner-circle"></div>
        </div>
      </div>

      <div class="child" id="start-container">
        <div class="start-button" id="startbutton"></div>
      </div>

      <div class="child" id="buttons">
        <div class="gameboy-button" id="xbutton">B</div>
        <div class="gameboy-button" id="zbutton">A</div>
      </div>
    </div>

    <script>
      function resizeGameCanvas() {
        const canvas = document.getElementById('canvas');
        if (!canvas) return;

        const baseW = 240;
        const baseH = 160;
        const aspect = baseW / baseH;

        const vv = window.visualViewport;
        const vw = (vv ? vv.width : window.innerWidth) || window.innerWidth;
        const vh = (vv ? vv.height : window.innerHeight) || window.innerHeight;

        const availW = vw;
        const availH = vh;

        let h = availH;
        let w = h * aspect;
        if (w > availW) {
          w = availW;
          h = w / aspect;
        }

        canvas.style.width = `${Math.floor(w)}px`;
        canvas.style.height = `${Math.floor(h)}px`;
      }

      function onViewportChange() {
        resizeGameCanvas();
      }

      window.addEventListener('load', onViewportChange, { passive: true });
      window.addEventListener('resize', onViewportChange, { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(onViewportChange, 250), {
        passive: true,
      });

      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', onViewportChange, { passive: true });
      }

      // iOS Safari: prevent page scroll / pinch zoom / callouts while interacting
      (function () {
        const ua = navigator.userAgent || '';
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        if (!isIOS) return;

        const blocker = (e) => {
          e.preventDefault();
        };

        document.addEventListener('touchstart', blocker, { passive: false });
        document.addEventListener('touchmove', blocker, { passive: false });

        document.addEventListener('gesturestart', blocker, { passive: false });
        document.addEventListener('gesturechange', blocker, { passive: false });
        document.addEventListener('gestureend', blocker, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener(
          'touchend',
          (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
          },
          { passive: false },
        );
      })();
    </script>
  </body>
</html>
