<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <title>forzenboy</title>

    <!-- Set the mobile class ASAP to avoid a flash of wrong layout -->
    <script>
      (function () {
        const ua = navigator.userAgent || '';
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        // Touch capability
        const hasTouch =
          (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) || 'ontouchstart' in window;

        // Consider it "mobile UI" if it's Android/iOS with touch.
        // This sidesteps inconsistent hover/pointer media-query reporting on some Samsung devices.
        const isMobile = hasTouch && (isAndroid || isIOS);

        if (isMobile) document.documentElement.classList.add('is-mobile');
      })();
    </script>

    <script type="module" src="./bundle.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        background: #2d2d2d;
        overscroll-behavior: none;
      }

      canvas {
        display: block;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
        touch-action: none;
      }

      /* Defaults = desktop */
      .hide-mobile {
        display: none !important;
      }
      .hide-desktop {
        display: flex !important;
      }

      /* Wrapper centers canvas on desktop */
      .canvas-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #2d2d2d;
      }

      .child {
        width: 50%;
        display: flex;
        align-items: flex-end;
      }

      .gameboy-button {
        opacity: 0.4;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 60px; /* keep big always */
        height: 60px; /* keep big always */
        background-color: #5c5c5c;
        border-radius: 50%;
        box-shadow:
          inset 0 0 0 5px #9c9c9c,
          inset 0 0 0 10px #404040;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 20px;
        color: #1c1c1c;
        user-select: none;
        transition: 0.1s ease-in-out;
      }

      .gameboy-button:active {
        transform: translateY(2px);
        box-shadow:
          inset 0 0 0 5px #9c9c9c,
          inset 0 0 0 8px #404040;
      }

      /* NEW: NES-style start button (oval, no label) */
      .start-button {
        opacity: 0.4;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 96px;
        height: 34px;
        background-color: #5c5c5c;
        border-radius: 999px; /* pill */
        box-shadow:
          inset 0 0 0 4px #9c9c9c,
          inset 0 0 0 8px #404040;
        user-select: none;
        transition: 0.1s ease-in-out;
      }

      .start-button:active {
        transform: translateY(2px);
        box-shadow:
          inset 0 0 0 4px #9c9c9c,
          inset 0 0 0 6px #404040;
      }

      #buttons {
        justify-content: flex-end;
        padding: 0.5in;
      }

      #joystick-container {
        justify-content: flex-start;
        padding: 0.33in;
      }

      /* NEW: center slot for start button */
      #start-container {
        width: auto;
        justify-content: center;
        padding: 0.33in 0;
      }

      .joystick {
        position: relative;
        width: 1in;
        height: 1in;
        border-radius: 50%;
        opacity: 0.4;
        border: 1px solid #fff;
        background-color: #666;
        user-select: none;
      }

      .joystick .inner-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0.66in;
        height: 0.66in;
        margin-top: -0.33in;
        margin-left: -0.33in;
        border-radius: 50%;
        opacity: 0.4;
        background-color: #fff;
        user-select: none;
      }

      /* ============================================================
         MOBILE UI: driven by html.is-mobile (reliable on Samsung)
         ============================================================ */
      html.is-mobile,
      html.is-mobile body {
        background: black !important;
      }

      html.is-mobile body {
        /* tiny scroll to encourage browser chrome collapse */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      html.is-mobile .hide-mobile {
        display: flex !important;
      }

      html.is-mobile .hide-desktop {
        display: none !important;
      }

      html.is-mobile .canvas-wrapper {
        background: black !important;
        width: 100vw;
        height: 100vh; /* fallback */
        height: 100dvh; /* visible viewport when supported */
      }

      html.is-mobile canvas {
        max-width: 100%;
        max-height: 100%;
      }

      /* Overlay controls: no blur/backdrop, overlaps canvas */
      html.is-mobile #control-pane {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        display: flex;
        z-index: 999999;

        height: 110px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-top: 10px;

        background: transparent;
        pointer-events: auto;
      }

      html.is-mobile .child {
        align-items: center;
      }

      html.is-mobile #joystick-container {
        padding: 10px 12px;
      }

      /* NEW: start container spacing for mobile */
      html.is-mobile #start-container {
        padding: 10px 0;
        justify-content: center;
      }

      html.is-mobile #buttons {
        padding: 10px 12px;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
      }

      /* joystick stays big */
      html.is-mobile .joystick {
        width: 96px;
        height: 96px;
      }

      html.is-mobile .joystick .inner-circle {
        width: 64px;
        height: 64px;
        margin-top: -32px;
        margin-left: -32px;
      }

      /* Optional fallback: keep your original media query too (doesn't hurt) */
      @media (hover: none) and (pointer: coarse) {
        /* If some device matches this but JS didn't add is-mobile, still show controls */
        html:not(.is-mobile) .hide-mobile {
          display: flex !important;
        }
        html:not(.is-mobile) .hide-desktop {
          display: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="canvas-wrapper">
      <canvas id="canvas" width="240" height="160"></canvas>
    </div>

    <div class="hide-mobile" id="control-pane">
      <div class="child" id="joystick-container">
        <div class="joystick">
          <div class="inner-circle"></div>
        </div>
      </div>

      <!-- NEW: Start button in the middle -->
      <div class="child" id="start-container">
        <div class="start-button" id="startbutton"></div>
      </div>

      <div class="child" id="buttons">
        <div class="gameboy-button" id="xbutton">B</div>
        <div class="gameboy-button" id="zbutton">A</div>
      </div>
    </div>

    <script>
      function resizeGameCanvas() {
        const canvas = document.getElementById('canvas');
        if (!canvas) return;

        const baseW = 240;
        const baseH = 160;
        const aspect = baseW / baseH;

        const vv = window.visualViewport;
        const vw = (vv ? vv.width : window.innerWidth) || window.innerWidth;
        const vh = (vv ? vv.height : window.innerHeight) || window.innerHeight;

        // Controls overlap canvas; do not subtract their height.
        const availW = vw;
        const availH = vh;

        // Height-first fit (use full height if possible)
        let h = availH;
        let w = h * aspect;
        if (w > availW) {
          w = availW;
          h = w / aspect;
        }

        canvas.style.width = `${Math.floor(w)}px`;
        canvas.style.height = `${Math.floor(h)}px`;
      }

      // Best-effort chrome collapse
      function nudgeBars() {
        const isMobile = document.documentElement.classList.contains('is-mobile');
        if (isMobile) {
          document.body.style.minHeight = 'calc(100dvh + 1px)';
          window.scrollTo(0, 1);
        }
      }

      function onViewportChange() {
        resizeGameCanvas();
        setTimeout(nudgeBars, 0);
      }

      window.addEventListener('load', onViewportChange, { passive: true });
      window.addEventListener('resize', onViewportChange, { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(onViewportChange, 250), {
        passive: true,
      });

      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', onViewportChange, { passive: true });
        window.visualViewport.addEventListener('scroll', onViewportChange, { passive: true });
      }
    </script>
  </body>
</html>
